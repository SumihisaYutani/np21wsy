# NP21WSY 現在のステートセーブ実装分析レポート

## 1. 概要

本レポートは、NP21W PC-9801エミュレータの現在のステートセーブ機能について、詳細な技術分析を行った結果をまとめたものです。要件定義のための基礎資料として作成しました。

---

## 2. ファイル構成とアーキテクチャ

### 2.1 コアファイル

#### 主要実装ファイル
- **`statsave.h`** - ステートセーブAPI定義
- **`statsave.c`** - メイン実装 (1,973行)
- **`statsave.tbl`** - データテーブル定義 (213行)

#### 関連ファイル
- **`pccore.h`** - システム状態定義
- **`nevent.h`** - イベント管理
- **プラットフォーム固有UI** - Windows, X11, SDL2対応

### 2.2 アーキテクチャ特徴

#### セクション構造
```c
typedef struct {
    char    index[10];  // セクション名
    UINT16  ver;        // バージョン
    UINT32  size;       // データサイズ
} NP2FENT;
```

#### データ管理方式
- **セクション単位管理**: 各コンポーネントが独立したセクション
- **バージョン管理**: セクション毎のバージョン管理
- **互換性フラグ**: 前方/後方互換性制御

---

## 3. 現在の機能分析

### 3.1 基本機能

#### ステートセーブ対象
```c
// 主要なセーブ対象（statsave.tblより）
{"PCCORE",    0, STATFLAG_BIN, &pccore,     sizeof(pccore)},
{"CPU286",    0, STATFLAG_BIN, &CPU_STATSAVE, sizeof(CPU_STATSAVE)},
{"MEMORY",    0, STATFLAG_MEM, NULL,        0x130000},
{"EXTMEM",    0, STATFLAG_EXT, NULL,        0},
{"FMBOARD",   0, STATFLAG_FM,  NULL,        0},
// ... 他50項目以上
```

#### 保存される状態
1. **CPU状態**: レジスタ、フラグ、実行状態
2. **メモリ**: メインメモリ、VRAM、拡張メモリ
3. **デバイス状態**: FDD, HDD, サウンド, グラフィック
4. **イベント状態**: タイマー、割り込み
5. **設定情報**: ディスクイメージパス、タイムスタンプ

### 3.2 ファイル形式

#### ヘッダ構造
```c
typedef struct {
    char    name[16];      // "Neko Project II"
    char    vername[28];   // "create by NP2.EXE"
    UINT32  ver;           // バージョン (現在 10850)
} NP2FHDR;
```

#### セクション構造
```
[NP2FHDR]
[SECTION1]
  [NP2FENT header]
  [data + padding to 16byte boundary]
[SECTION2]
  [NP2FENT header]
  [data + padding]
...
[TERMINATE section]
```

### 3.3 エラーハンドリング

#### 整合性チェック
- **ディスク変更検出**: ファイルタイムスタンプ比較
- **バージョン互換性**: セクション単位の互換性判定
- **データ破損検出**: セクションサイズ検証

#### エラーフラグ
```c
enum {
    STATFLAG_SUCCESS   = 0,
    STATFLAG_DISKCHG   = 0x0001,  // ディスク変更
    STATFLAG_VERCHG    = 0x0002,  // バージョン変更
    STATFLAG_WARNING   = 0x0080,  // 警告
    STATFLAG_VERSION   = 0x0100,  // バージョン問題
    STATFLAG_FAILURE   = -1       // 失敗
};
```

---

## 4. プラットフォーム別実装

### 4.1 Windows版

#### ファイル
- **`win9x/np2.cpp`** - メインウィンドウ処理
- **`win9x/menu.cpp`** - メニュー管理
- **`win9x/resource.h`** - リソース定義

#### 機能
```c
// メニューID定義
#define IDM_FLAGSAVE0    40201  // スロット0セーブ
#define IDM_FLAGSAVE1    40202  // スロット1セーブ
// ...
#define IDM_FLAGLOAD0    40251  // スロット0ロード
#define IDM_FLAGLOAD1    40252  // スロット1ロード
```

#### スロット数制限
```c
#define SUPPORT_STATSAVE 10  // 最大10スロット
```

#### 実装詳細
- **ファイル命名**: `np2.{スロット番号:03d}` (例: np2.000, np2.001)
- **保存場所**: 実行ファイルと同じディレクトリ
- **UI**: メニューからの選択のみ
- **再開機能**: プログラム終了時の自動保存/復元

### 4.2 X11版

#### ファイル
- **`x11/gtk2/gtk_menu.c`** - GTKメニュー実装
- **`x11/ini.c`** - 設定管理

#### 機能特徴
- **マルチスロット対応**: Windows版と同様の10スロット
- **GTK UIintegration**: GTKメニューシステム使用
- **設定保存**: INIファイル形式での設定管理

### 4.3 SDL2版

#### 実装状況
- **基本機能**: コア機能は共通実装を使用
- **UI制限**: プラットフォーム固有UIは限定的
- **ファイル操作**: 基本的なファイル選択のみ

---

## 5. API分析

### 5.1 公開API

#### 基本操作
```c
// メインAPI (statsave.h)
int statsave_save(const OEMCHAR *filename);
int statsave_check(const OEMCHAR *filename, OEMCHAR *buf, int size);
int statsave_load(const OEMCHAR *filename);
```

#### 内部API
```c
// 低レベル操作
int statflag_read(STFLAGH sfh, void *ptr, UINT size);
int statflag_write(STFLAGH sfh, const void *ptr, UINT size);
void statflag_seterr(STFLAGH sfh, const OEMCHAR *str);
```

### 5.2 UI統合API

#### Windows版UI統合
```c
// np2.cpp内の実装
static int flagsave(const OEMCHAR *ext);
static int flagload(HWND hWnd, const OEMCHAR *ext, LPCTSTR title, BOOL force);
static void flagdelete(const OEMCHAR *ext);
```

#### 処理フロー
1. **UI操作**: メニュー選択 → WM_COMMAND
2. **メインスレッド停止**: `np2_multithread_Suspend()`
3. **サウンド停止**: `soundmng_stop()`
4. **ステート操作**: `statsave_save/load()`
5. **サウンド再開**: `soundmng_play()`
6. **メインスレッド再開**: `np2_multithread_Resume()`

---

## 6. データ構造詳細

### 6.1 セーブ対象の分類

#### カテゴリ別データ量（概算）
- **CPU状態**: ~200 bytes
- **メイン/拡張メモリ**: 1MB-64MB (設定依存)
- **VRAM**: ~500KB
- **デバイス状態**: ~50KB
- **サウンド状態**: ~10KB
- **設定/パス情報**: ~5KB

#### セクションタイプ
```c
enum {
    STATFLAG_BIN    = 0,  // バイナリデータ
    STATFLAG_TERM   = 1,  // 終端マーカー
    STATFLAG_COM    = 2,  // 通信デバイス
    STATFLAG_DMA    = 3,  // DMAコントローラ
    STATFLAG_EGC    = 4,  // 拡張グラフィック
    STATFLAG_EVT    = 6,  // イベントシステム
    STATFLAG_EXT    = 7,  // 拡張メモリ
    STATFLAG_FDD    = 8,  // フロッピーディスク
    STATFLAG_FM     = 9,  // FM音源
    STATFLAG_MEM    = 12, // メインメモリ
    STATFLAG_SXSI   = 13, // ストレージ
};
```

### 6.2 互換性管理

#### 互換性フラグ
```c
#define STATFLAG_BWD_COMPATIBLE  0x4000  // 後方互換
#define STATFLAG_FWD_COMPATIBLE  0x8000  // 前方互換
```

#### バージョン管理方針
- **セクション単位**: 各セクションが独立したバージョン
- **段階的更新**: 古いバージョンとの互換性維持
- **警告システム**: 互換性問題の通知

---

## 7. 現在の制限と問題点

### 7.1 機能的制限

#### ユーザビリティ
1. **スロット管理**:
   - 名前付け不可（番号のみ）
   - 作成日時表示なし
   - 説明文なし
   - サムネイル/スクリーンショットなし

2. **操作性**:
   - メニューからのアクセスのみ
   - ホットキー制限（F5/F9なし）
   - 進捗表示なし
   - バッチ操作不可

3. **情報不足**:
   - プレイ時間記録なし
   - ゲーム/ディスク情報なし
   - 統計情報なし

#### 技術的制限
1. **ファイル管理**:
   - 単一ディレクトリ保存
   - ファイル名固定（拡張子のみ変更）
   - 圧縮機能なし
   - エクスポート/インポートなし

2. **自動化機能**:
   - オートセーブなし
   - 定期保存なし
   - 終了時保存オプション限定

### 7.2 パフォーマンス問題

#### 保存/復元速度
- **大容量メモリ**: 64MB設定では数秒要する
- **ブロッキング処理**: UI完全停止
- **進捗表示**: 経過表示なし

#### メモリ使用量
- **一時的使用**: 保存/復元時に大量メモリ使用
- **圧縮なし**: ファイルサイズが大きい

### 7.3 プラットフォーム差異

#### Windows vs X11 vs SDL2
- **UI統合度**: Windowsが最も充実
- **機能差**: 基本機能は共通、UI機能で差
- **設定保存**: プラットフォーム毎に異なる形式

---

## 8. 互換性分析

### 8.1 既存ファイル形式

#### 強み
- **堅牢な設計**: セクション構造による拡張性
- **バージョン管理**: 段階的アップグレード可能
- **互換性フラグ**: 前方/後方互換性制御

#### 拡張可能性
- **新セクション追加**: 既存ファイルとの互換性維持
- **メタデータ追加**: 追加情報の埋め込み可能
- **圧縮対応**: データ部分の圧縮実装可能

### 8.2 移行戦略

#### 段階的移行
1. **Phase 1**: メタデータ追加（互換性維持）
2. **Phase 2**: UI機能拡張
3. **Phase 3**: 新機能追加（オートセーブ等）

#### 後方互換性維持
- **形式検出**: ファイル形式の自動判別
- **変換機能**: 旧形式→新形式の変換
- **設定オプション**: 旧形式出力オプション

---

## 9. 要件定義のための考察

### 9.1 現在の実装評価

#### 優秀な点
1. **技術的完成度**: コア機能は非常に安定
2. **拡張性**: セクション構造による高い拡張性
3. **信頼性**: 長期間の実績による安定性
4. **互換性**: バージョン管理システムの存在

#### 改善が必要な点
1. **ユーザビリティ**: 現代的なUI機能の不足
2. **情報管理**: メタデータの不足
3. **自動化**: オートセーブ等の便利機能なし
4. **操作性**: ホットキー、進捗表示等の不足

### 9.2 拡張方針

#### 基本戦略
- **既存実装の活用**: コア機能はそのまま活用
- **段階的拡張**: 互換性を保ちながら機能追加
- **UI刷新**: 現代的なユーザーインターフェース

#### 技術的課題
1. **データサイズ**: 大容量メモリ対応の最適化
2. **リアルタイム性**: オートセーブの実装
3. **クロスプラットフォーム**: 統一されたUI体験

---

## 10. まとめ

NP21Wの現在のステートセーブ実装は、技術的には非常に完成度が高く、堅牢な設計となっています。セクション構造とバージョン管理システムにより、将来の拡張に対する基盤が既に整っています。

一方で、ユーザビリティの面では現代的なエミュレータに求められる機能が不足しており、特に以下の点で改善の余地があります：

- **情報管理**: スクリーンショット、メタデータの不足
- **操作性**: ホットキー、進捗表示、バッチ操作の不足
- **自動化**: オートセーブ、定期保存機能の不足
- **管理機能**: 名前付け、検索、整理機能の不足

要件定義においては、既存の技術的基盤を活かしつつ、これらのユーザビリティ向上を主軸とした機能拡張を検討することが適切と考えられます。
