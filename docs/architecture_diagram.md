# NP21WSY PC-9801 Emulator - Architecture Diagram

## システム全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Platform Layer                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │    SDL2     │  │    Win9x    │  │     X11     │  │    macOS    │     │
│  │  (Cross     │  │ (Windows    │  │  (Linux/    │  │  (Cocoa)    │     │
│  │ Platform)   │  │  Native)    │  │   Unix)     │  │             │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
         │                   │                   │              │
         ▼                   ▼                   ▼              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Core Emulation Layer                              │
│                                                                         │
│  ┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐     │
│  │   CPU Cores     │    │   Event System   │    │  Configuration  │     │
│  │                 │    │                  │    │   Management    │     │
│  │  ┌───────────┐  │    │ ┌──────────────┐ │    │                 │     │
│  │  │  i286c    │  │    │ │ NEVENT Core  │ │    │  ┌───────────┐  │     │
│  │  │ (80286)   │  │    │ │  (32 slots)  │ │    │  │  NP2CFG   │  │     │
│  │  └───────────┘  │    │ └──────────────┘ │    │  │  PCCORE   │  │     │
│  │                 │    │                  │    │  │  PCSTAT   │  │     │
│  │  ┌───────────┐  │    │ ┌──────────────┐ │    │  └───────────┘  │     │
│  │  │  i286x    │  │    │ │ Clock Sync   │ │    │                 │     │
│  │  │(Enhanced) │  │    │ │ Management   │ │    │                 │     │
│  │  └───────────┘  │    │ └──────────────┘ │    │                 │     │
│  │                 │    │                  │    │                 │     │
│  │  ┌───────────┐  │    └──────────────────┘    │                 │     │
│  │  │  i386c    │  │                            │                 │     │
│  │  │ (80386)   │  │                            │                 │     │
│  │  └───────────┘  │                            │                 │     │
│  │                 │                            │                 │     │
│  │  ┌───────────┐  │                            │                 │     │
│  │  │ i386hax   │  │                            │                 │     │
│  │  │ (HAXM)    │  │                            │                 │     │
│  │  └───────────┘  │                            │                 │     │
│  └─────────────────┘                            └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Hardware Emulation Layer                            │
│                                                                         │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│ │Memory Mgmt  │ │   I/O Bus   │ │Graphics/VGA │ │ Sound/Audio │         │
│ │             │ │             │ │             │ │             │         │
│ │┌───────────┐│ │┌───────────┐│ │┌───────────┐│ │┌───────────┐│         │
│ ││MemoryMap  ││ ││  IOCore   ││ ││  VRAM     ││ ││Sound Core ││         │
│ ││ Management││ ││ (8/10/12/ ││ ││Management ││ ││           ││         │
│ │└───────────┘│ ││ 16-bit)   ││ │└───────────┘│ │└───────────┘│         │
│ │             │ │└───────────┘│ │             │ │             │         │
│ │┌───────────┐│ │             │ │┌───────────┐│ │┌───────────┐│         │
│ ││EMS/XMS    ││ │┌───────────┐│ ││ GDC       ││ ││FM Synth   ││         │
│ ││Support    ││ ││   PIC     ││ ││ (Graphics ││ ││(OPN/OPNA) ││         │
│ │└───────────┘│ ││           ││ ││Display    ││ │└───────────┘│         │
│ │             │ │└───────────┘│ ││Control)   ││ │             │         │
│ │┌───────────┐│ │             │ │└───────────┘│ │┌───────────┐│         │
│ ││VRAM       ││ │┌───────────┐│ │             │ ││PCM/ADPCM  ││         │
│ ││Mapping    ││ ││   PIT     ││ │┌───────────┐│ ││Support    ││         │
│ │└───────────┘│ ││           ││ ││ CRTC      ││ │└───────────┘│         │
│ └─────────────┘ │└───────────┘│ ││           ││ └─────────────┘         │
│                 │             │ │└───────────┘│                         │
│                 │┌───────────┐│ │             │                         │
│                 ││   DMAC    ││ │┌───────────┐│ ┌─────────────┐         │
│                 ││           ││ ││ EGC       ││ │Storage Emul.│         │
│                 │└───────────┘│ ││(Enhanced  ││ │             │         │
│                 └─────────────┘ ││Graphics)  ││ │┌───────────┐│         │
│                                 │└───────────┘│ ││FDD Control││         │
│                                 └─────────────┘ ││           ││         │
│                                                 │└───────────┘│         │
│                                                 │             │         │
│                                                 │┌───────────┐│         │
│                                                 ││SASI/SCSI/ ││         │
│                                                 ││IDE Support││         │
│                                                 │└───────────┘│         │
│                                                 └─────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        BIOS & ROM Layer                                  │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ System BIOS │  │ Sound BIOS  │  │ SASI BIOS   │  │ ITF ROM     │     │
│  │             │  │             │  │             │  │             │     │
│  │ • INT 09h-  │  │ • FM/PCM    │  │ • HDD Boot  │  │ • Font Data │     │
│  │   1Fh       │  │   Initialize│  │ • SCSI      │  │ • System    │     │
│  │ • Boot      │  │ • Board     │  │   Commands  │  │   Resources │     │
│  │   Sequence  │  │   Setup     │  │             │  │             │     │
│  │ • Hardware  │  │             │  │             │  │             │     │
│  │   Initialize│  │             │  │             │  │             │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

## データフロー図

```
User Input → Platform Layer → Event System → CPU Core → Hardware Emulation
                    ↓               ↓            ↓             ↓
    ┌────────────────────────────────────────────────────────────────┐
    │                    Event Processing                            │
    └────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────────────┐
    │                  Memory & I/O Operations                       │
    └────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────────────┐
    │                   Hardware State Update                        │
    └────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────────────┐
    │              Platform Layer Output (Video/Audio)               │
    └────────────────────────────────────────────────────────────────┘
```

## コンポーネント間相互作用

### CPU → Memory/I/O
- CPU命令実行により物理メモリアクセス（`memp_read8/16/32`, `memp_write8/16/32`）
- I/Oポートアクセス（`iocore_inp8/16/32`, `iocore_out8/16/32`）
- 割り込み処理（PIC経由）

### Event System → All Components
- タイマー割り込み（NEVENT_ITIMER）
- 画面更新（NEVENT_FLAMES）
- サウンド処理（NEVENT_FMTIMERA/B）
- デバイス固有イベント

### Graphics Pipeline
1. CPU → VRAM Write
2. VRAM → Graphics Controller (GDC)
3. GDC → CRTC → Display
4. Platform Layer → Video Output

### Audio Pipeline
1. CPU → Sound Board Registers
2. FM Synthesizer/PCM → Sound Buffer
3. Sound Core → Platform Audio
4. Platform Layer → Audio Output

## 主要な設計パターン

1. **Layer-based Architecture**: Platform抽象化による移植性
2. **Event-driven System**: 統一されたタイミング管理
3. **Component-based Design**: 各ハードウェアの独立した実装
4. **Configuration-driven**: 実行時設定による柔軟性
5. **State Persistence**: 完全なエミュレータ状態の保存/復元

## ファイル構成とモジュール

| ディレクトリ | 役割 | 主要ファイル |
|-------------|------|-------------|
| `/` | コア制御 | pccore.c/h, nevent.c/h, common.h |
| `i286c/` | 80286 CPU | i286c.c/h, cpumem.c/h |
| `i386c/` | 80386 CPU | cpucore.c/h, ia32/ |
| `io/` | I/O制御 | iocore.c/h, pic.c/h, dmac.c/h |
| `mem/` | メモリ管理 | memegc.c/h, memvram.c/h |
| `vram/` | グラフィック | vram.h, maketext.c, makegrph.c |
| `sound/` | サウンド | sound.h, soundrom.c |
| `cbus/` | 拡張ボード | board*.c/h |
| `fdd/` | ストレージ | diskdrv.c/h, sxsi.c/h |
| `bios/` | BIOS | bios*.c/h |
| `sdl2/`, `win9x/`, `x11/` | プラットフォーム | プラットフォーム固有実装 |