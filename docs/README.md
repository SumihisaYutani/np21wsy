# NP21WSY PC-9801 Emulator - Documentation

このディレクトリには、NP21WSY PC-9801エミュレータの包括的な技術ドキュメントが含まれています。

## ドキュメント一覧

### 🏗️ [アーキテクチャー図](./architecture_diagram.md)
- システム全体のアーキテクチャと各層の関係
- データフロー図とコンポーネント間相互作用
- ファイル構成とモジュール説明

### 🔗 [ER図](./entity_relationship_diagram.md)
- データエンティティ間の関係性
- 設定管理、CPU、メモリ、I/O、グラフィック系の関係図
- 状態保存・復元システムの構造

### 📊 [クラス図](./class_diagram.md)
- 主要なC構造体と関数モジュールの関係
- インターフェース継承関係とデザインパターン
- コールバック・委譲パターンの実装

### 📋 [データ構造仕様書](./data_structure_specification.md)
- 全主要構造体の詳細仕様
- メンバー変数の意味と使用方法
- データアクセスパターンと最適化指針

### 🔌 [インターフェース仕様書](./interface_specification.md)
- プラットフォーム抽象化インターフェース
- コア制御・I/O・メモリアクセスAPI
- ステートセーブシステム（基本・拡張API）
- エラーハンドリングとパフォーマンス最適化

## プロジェクト概要

**NP21WSY**は、PC-9801シリーズを高精度にエミュレートするソフトウェアです。

### 主要特徴
- **CPU**: 80286/80386/80386+HAXM対応
- **プラットフォーム**: Windows, Linux, macOS, iOS対応
- **サウンド**: FM音源(OPN/OPNA)、PCM、MIDI完全対応
- **グラフィック**: テキスト/グラフィックモード、EGC/GRCG対応
- **ストレージ**: FDD, SASI/SCSI/IDE HDD対応
- **ステートセーブ**: 200スロット対応の拡張セーブシステム

### アーキテクチャ特徴
- **レイヤード設計**: プラットフォーム非依存のコア実装
- **イベント駆動**: 統一されたタイミング管理システム
- **モジュラー構成**: 各ハードウェアの独立実装
- **設定駆動**: 実行時設定による高い柔軟性

## ディレクトリ構造

```
np21wsy/
├── docs/                   # このドキュメント
├── i286c/                  # 80286 CPU エミュレーション
├── i386c/                  # 80386 CPU エミュレーション
├── i386hax/                # Intel HAXM 対応
├── io/                     # I/O デバイス制御
├── mem/                    # メモリ管理
├── vram/                   # グラフィック処理
├── sound/                  # サウンドシステム
├── cbus/                   # 拡張ボード
├── fdd/                    # ストレージ制御
├── bios/                   # BIOS エミュレーション
├── sdl2/                   # SDL2 プラットフォーム
├── win9x/                  # Windows プラットフォーム
├── x11/                    # X11 プラットフォーム
├── common/                 # 共通ユーティリティ
├── font/                   # フォント処理
├── diskimage/              # ディスクイメージ処理
└── romimage/               # ROM イメージ処理
```

## 開発者向け情報

### ビルド要件
- **VST3_SDK**: サウンド処理用
- **WinDDK**: Windows版ビルド用
- **NASM/YASM**: アセンブリ部分のビルド用

### 設定パラメータ
- `MEMOPTIMIZE`: メモリ最適化レベル (0-2)
- `CPUCORE_IA32`: IA32アーキテクチャ使用
- `SUPPORT_*`: 各種機能サポートフラグ

### デバッグ・プロファイリング
- CPU panic 表示用の `msgbox()` API実装が必要
- `SUPPORT_WAVEREC`: Wave録音機能（デバッグ用）
- `SUPPORT_S98`: S98ログ出力機能

## パフォーマンス指針

### 最適化レベル
- **MEMOPTIMIZE=0**: x86向け最適化
- **MEMOPTIMIZE=1**: PowerPC系RISC向け
- **MEMOPTIMIZE=2**: ARM系組み込み向け

### クリティカルパス
1. **CPU命令実行**: 最高頻度の処理
2. **メモリアクセス**: VRAMアクセス最適化重要
3. **I/O処理**: ポートデコード効率化
4. **サウンド生成**: リアルタイム性確保

## トラブルシューティング

### よくある問題
- **文字化け**: `OSLANG_*`設定の確認
- **音が出ない**: サウンドボード設定とサンプリングレート
- **描画不正**: VRAM設定とグラフィックモード
- **動作速度**: クロック設定と最適化レベル

### デバッグ手順
1. 設定ファイル（NP2CFG構造体）の確認
2. イベントシステムのタイミング検証
3. I/Oポートアクセスログの取得
4. CPUレジスタダンプの確認

## ライセンス・著作権

このドキュメントはNP21WSYプロジェクトの一部として提供されています。
プロジェクト本体のライセンスに従います。

---

**作成日**: 2024年9月20日
**対象バージョン**: NP21WSY (全バージョン対応)
**文書形式**: Markdown (GitHub Flavored)

このドキュメントは、NP21WSYの理解・開発・保守・移植作業を支援することを目的として作成されました。