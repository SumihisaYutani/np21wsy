# NP21WSY トラブルシューティングガイド

## 1. 概要

本ガイドでは、NP21WSY PC-9801エミュレータでよく発生する問題と解決方法について説明します。
問題が発生した際は、このガイドを参考に段階的な対処を行ってください。

---

## 2. 起動・初期化の問題

### 2.1 エミュレータが起動しない

#### 症状
- エミュレータの実行ファイルをダブルクリックしても何も起こらない
- エラーメッセージが表示される
- 起動途中でクラッシュする

#### 原因と対策

**1. 必要なランタイムライブラリが不足**
- **Windows版**: Visual C++ Redistributableをインストール
- **SDL2版**: SDL2ライブラリが必要
- **解決方法**: 公式サイトから必要なランタイムをダウンロード・インストール

**2. 設定ファイルの破損**
```ini
# 設定ファイルを初期化（Windows版の場合）
# np21w.ini を削除または名前変更
# エミュレータが自動的に新しい設定ファイルを作成
```

**3. 権限不足**
- **症状**: アクセス拒否エラー
- **解決方法**: 管理者権限で実行、またはユーザーフォルダに移動

**4. ウイルス対策ソフトによるブロック**
- **症状**: 実行ファイルが検疫される
- **解決方法**: ウイルス対策ソフトの除外リストに追加

### 2.2 PC-98の起動画面が表示されない

#### 症状
- エミュレータは起動するが、画面が真っ黒
- PC-98のロゴが表示されない

#### 原因と対策

**1. PCモデル設定の確認**
```ini
[NekoProjectII]
pc_model=VX    # 標準的なモデルに変更
```

**2. DIPスイッチ設定の確認**
```ini
DIPswtch=3e 73 7b    # 標準設定に戻す
```

**3. BIOSファイルの確認**
- PC-98 BIOSファイルが正しく配置されているか確認
- ファイルが破損していないかチェック

**4. グラフィック設定の確認**
```ini
DispSync=1      # 表示同期を有効
DRAWTYPE=0      # GDI描画に変更
GRCG_EGC=1      # 基本グラフィック機能
```

---

## 3. 表示・グラフィックの問題

### 3.1 画面が乱れる・正しく表示されない

#### 症状
- 文字が読めない
- 色が正しくない
- 画面がちらつく
- 表示が崩れる

#### 原因と対策

**1. 表示同期の調整**
```ini
DispSync=2      # 厳密同期に変更
skipline=0      # ライン飛ばし無効
skiplight=0     # ライトスキップ無効
```

**2. 色設定の確認**
```ini
color16b=1      # 16色モード有効
realpal=1       # 実機相当パレット
BG_COLOR=000000 # 背景色：黒
FG_COLOR=ffffff # 文字色：白
```

**3. グラフィック機能の調整**
```ini
GRCG_EGC=0      # 基本機能のみ使用
usepegcplane=0  # PEGC無効化
```

**4. 描画方式の変更**
```ini
DRAWTYPE=0      # GDI描画
EMUDDRAW=0      # DirectDrawエミュレーション無効
hwaccel=0       # ハードウェアアクセラレーション無効
```

### 3.2 フルスクリーンで問題が発生

#### 症状
- フルスクリーンで画面が真っ黒
- 解像度が正しくない
- フルスクリーンから戻れない

#### 原因と対策

**1. フルスクリーン設定の確認**
```ini
fullscreen=0    # ウィンドウモードに戻す
fullscrn_out=0  # フルスクリーン出力方式
```

**2. 表示倍率の調整**
```ini
multiple=1      # 1倍表示に設定
aspect=0        # オリジナル比率維持
```

**3. キーボードショートカット**
- **Alt + Enter**: フルスクリーン切り替え
- **Alt + F4**: エミュレータ終了

---

## 4. サウンドの問題

### 4.1 音が出ない

#### 症状
- 完全に音が聞こえない
- 特定の音源だけ聞こえない

#### 原因と対策

**1. 音量設定の確認**
```ini
volume_M=100    # マスター音量
volume_F=64     # FM音源音量
volume_S=64     # PSG音量
volume_A=64     # ADPCM音量
volume_P=64     # PCM音量
```

**2. サウンドボード設定の確認**
```ini
SNDboard=04     # PC-9801-86に設定
```

**3. サンプリングレート調整**
```ini
SampleHz=44100  # 44.1kHzに設定
Latencys=150    # レイテンシ調整
```

**4. システム音量の確認**
- OS側の音量設定をチェック
- 他のアプリケーションで音が出るか確認

### 4.2 音飛び・ノイズが発生

#### 症状
- 音が途切れる
- ノイズが混入する
- 音の遅延が発生

#### 原因と対策

**1. レイテンシの調整**
```ini
Latencys=200    # 遅延を増加させて安定化
```

**2. サンプリングレートを下げる**
```ini
SampleHz=22050  # 22.05kHzに下げる
```

**3. CPU負荷の軽減**
```ini
clk_mult=4      # クロック倍率を下げる
```

**4. 他のプロセスの終了**
- 不要なアプリケーションを終了
- バックグラウンドプロセスを確認

---

## 5. 入力デバイスの問題

### 5.1 キーボードが正しく動作しない

#### 症状
- キー入力が反応しない
- 違う文字が入力される
- 特定のキーが効かない

#### 原因と対策

**1. キーボード設定の確認**
```ini
KEY_MODE=0      # 標準キーボード
```

**2. キーリピート設定**
```ini
BTN_RAPID=31    # キーリピート調整
BTN_MODE=1      # ボタンモード
```

**3. システムキーフックの確認**
```ini
syskhook=0      # システムキーフック無効
```

**4. キーマッピングの確認**
- 日本語配列キーボードの設定
- 特殊キーの動作確認

### 5.2 マウスが動作しない

#### 症状
- マウスカーソルが動かない
- クリックが反応しない

#### 原因と対策

**1. マウス設定の確認**
```ini
MOUSERAPID=0    # 通常速度
rawmouse=0      # Rawマウス入力無効
```

**2. マウスドライバの確認**
- PC-98用マウスドライバが組み込まれているか
- ソフトウェアがマウス対応しているか

---

## 6. ストレージの問題

### 6.1 ディスクイメージが読み込めない

#### 症状
- FDイメージをマウントしても認識されない
- HDDイメージが起動しない
- エラーメッセージが表示される

#### 原因と対策

**1. ファイルパスの確認**
```ini
FDD1FILE=C:\disk\game.d88    # 正しいパスを指定
HDD1FILE=C:\hdd\system.hdd   # HDDパスの確認
```

**2. ファイル形式の確認**
- 対応形式: .d88, .fdi, .nfd, .dcp, .88d, .xdf等
- ファイルが破損していないかチェック

**3. ドライブ設定の確認**
```ini
fddequip=3      # FDD装備設定
usefd144=1      # 1.44MB対応
```

**4. ファイル属性の確認**
- 読み取り専用属性を解除
- ファイルの存在確認

### 6.2 ホストドライブが使用できない

#### 症状
- ホストPC側のフォルダにアクセスできない

#### 原因と対策

**1. ホストドライブ設定**
```ini
hdrvenable=1    # ホストドライブ有効
hdrvacc=1       # アクセス許可
hdrvroot=C:\np21w\hostdrive    # ルートディレクトリ
```

**2. Windows NT系での設定**
```ini
hdrvntenable=1  # NT系対応
```

**3. アクセス権限の確認**
- フォルダのアクセス権限設定
- セキュリティソフトによるブロック確認

---

## 7. 性能・パフォーマンスの問題

### 7.1 動作が重い・遅い

#### 症状
- エミュレーション速度が遅い
- ゲームの動作がカクカク
- 操作に遅延がある

#### 原因と対策

**1. CPU設定の最適化**
```ini
clk_mult=8      # クロック倍率を上げる
asynccpu=1      # 非同期CPU有効
timerfix=0      # タイマー修正無効
```

**2. メモリ設定の最適化**
```ini
ExMemory=16     # 大容量メモリ
memcheckspeed=1 # 高速メモリチェック
```

**3. グラフィック設定の軽量化**
```ini
DispSync=0      # 同期無効
skipline=1      # ライン飛ばし有効
DRAWTYPE=0      # GDI描画
```

**4. サウンド設定の軽量化**
```ini
SampleHz=22050  # サンプリングレート下げ
Latencys=200    # レイテンシ調整
```

### 7.2 動作が不安定

#### 症状
- ランダムにクラッシュする
- フリーズが発生する
- 予期しない動作

#### 原因と対策

**1. 互換性重視設定**
```ini
clk_mult=2      # 低速動作
fpu_type=0      # 正確なFPU
timerfix=1      # タイマー修正有効
asynccpu=0      # 同期CPU
```

**2. メモリ設定の保守的な値**
```ini
ExMemory=8      # 中程度のメモリ
EMSENABLE=0     # EMS無効
XMSENABLE=0     # XMS無効
```

**3. 待機時間の追加**
```ini
vramwait=1      # VRAM待機時間
tramwait=1      # テキストRAM待機時間
grcgwait=1      # GRCG待機時間
```

---

## 8. ソフトウェア固有の問題

### 8.1 特定のゲームが起動しない

#### 対策手順

**1. ゲーム情報の確認**
- 発売年、対応機種の確認
- 必要な音源ボード、メモリ量の確認

**2. 機種設定の調整**
```ini
pc_model=VX     # ゲーム対応機種に設定
```

**3. 音源ボード設定**
```ini
SNDboard=04     # PC-9801-86（一般的）
SNDboard=02     # PC-9801-26K（古いゲーム）
SNDboard=01     # PC-9801-14（初期ゲーム）
```

**4. CPU速度調整**
```ini
clk_mult=2      # 古いゲームは低速設定
clk_mult=8      # 新しいゲームは高速設定
```

### 8.2 Windows 3.1が起動しない

#### 症状
- Windows 3.1のセットアップが失敗
- 起動途中でハングアップ

#### 対策

**1. 高性能設定**
```ini
pc_model=FX     # 80286機種
clk_mult=8      # 高速CPU
ExMemory=16     # 大容量メモリ
```

**2. メモリ管理設定**
```ini
EMSENABLE=1     # EMS有効
XMSENABLE=1     # XMS有効
UMBENABLE=1     # UMB有効
EMSSIZE=16384   # EMS大容量
```

**3. サウンド設定**
```ini
SNDboard=08     # PC-9801-118（WSS互換）
```

---

## 9. 設定ファイルの問題

### 9.1 設定が保存されない

#### 症状
- 変更した設定が次回起動時に元に戻る
- 設定ファイルが更新されない

#### 原因と対策

**1. ファイル権限の確認**
- 設定ファイルが読み取り専用になっていないか
- フォルダの書き込み権限があるか

**2. ファイルパスの確認**
- 設定ファイルが正しい場所にあるか
- 複数の設定ファイルが存在しないか

**3. 管理者権限での実行**
- エミュレータを管理者権限で実行
- ユーザーフォルダへの移動

### 9.2 設定ファイルの破損

#### 症状
- エミュレータ起動時にエラー
- 設定が異常な値になる

#### 対策

**1. 設定ファイルの初期化**
```bash
# 設定ファイルを削除（バックアップ推奨）
# Windows版: np21w.ini
# SDL2版: np2.cfg
```

**2. 手動での設定復旧**
- バックアップから復元
- 最小限の設定で起動確認

---

## 10. 緊急時の対処法

### 10.1 完全に起動しなくなった場合

**手順1: セーフモード起動**
```ini
# 最小限の設定ファイルを作成
[NekoProjectII]
pc_model=VX
clk_mult=1
ExMemory=1
SNDboard=00
DispSync=0
```

**手順2: 段階的な設定復旧**
1. 基本設定で起動確認
2. 一つずつ設定を追加
3. 問題のある設定項目を特定

**手順3: クリーンインストール**
1. エミュレータを完全削除
2. 設定ファイルも削除
3. 新規インストール

### 10.2 データ救出

**重要なファイルのバックアップ**
- HDDイメージファイル
- セーブデータ
- 設定ファイル
- カスタムフォント

---

## 11. サポート情報

### 11.1 ログファイルの確認

**Windows版**
- デバッグ版でのログ出力確認
- Windowsイベントビューアでエラー確認

**SDL2版**
- コンソール出力の確認
- コアダンプファイルの解析

### 11.2 問題報告時の情報

**必要な情報**
1. NP21WSYのバージョン
2. OS・プラットフォーム情報
3. 使用していたソフトウェア
4. エラーメッセージ
5. 設定ファイルの内容
6. 再現手順

**設定ファイルの情報収集**
```ini
# 以下の設定項目を報告に含める
pc_model=
clk_mult=
ExMemory=
SNDboard=
DIPswtch=
MEMswtch=
```

---

## 12. 予防策

### 12.1 定期的なバックアップ

**バックアップ対象**
- 設定ファイル
- HDDイメージ
- セーブデータ
- カスタム設定

**推奨頻度**
- 重要な作業前後
- 週次バックアップ
- システム変更前

### 12.2 安定した設定の維持

**推奨設定の使用**
- 実績のある設定値を使用
- 大幅な変更は段階的に実施
- 変更前の設定をバックアップ

**動作確認の徹底**
- 設定変更後の動作テスト
- 複数のソフトウェアでの確認
- 長時間動作での安定性確認

---

このトラブルシューティングガイドを参考に、問題の解決に取り組んでください。
解決しない場合は、段階的な対処と情報収集を行い、必要に応じて専門的なサポートを求めてください。