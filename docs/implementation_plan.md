# HDI対応セーブ機能 実装計画

## 実装戦略

前回の実装で発生した問題を踏まえ、段階的で安全なアプローチを採用する。

### 基本方針
1. **最小限の変更から開始**
2. **各段階でコンパイル・テストを実施**
3. **既存機能への影響を最小化**
4. **段階的なロールバック可能性を確保**

## 段階別実装計画

### Stage 1: 基本構造の準備
**目標**: コンパイルエラーなしで基本構造を定義

#### 1.1 データ構造定義
- `statsave.h` にHDI関連構造体を追加
- 最小限の定数定義
- 関数プロトタイプの宣言

#### 1.2 基本関数のスタブ実装
- `statsave.c` に空の関数を実装
- 常に成功を返すスタブとして実装
- コンパイル確認

**成功条件**: エラーなくコンパイルできること

### Stage 2: HDI設定取得機能
**目標**: 現在のHDI設定を取得する機能を実装

#### 2.1 設定取得関数の実装
```c
static void get_current_hdi_config(NP2METADATA_HDI *metadata)
```

#### 2.2 対象設定
- HDD ファイルパス (`np2cfg.sasihdd`)
- FDD ファイルパス (`np2cfg.fddfile`) 
- IDE タイプ (`np2cfg.idetype`) - SUPPORT_IDEIO条件付き
- DIP スイッチ (`np2cfg.dipsw`)
- メモリ設定 (`np2cfg.memsw`)

#### 2.3 条件コンパイル対応
- `#ifdef SUPPORT_IDEIO` でIDE関連を条件分岐
- プラットフォーム依存コードの分離

**成功条件**: 現在の設定を正しく取得できること

### Stage 3: HDI検出機能
**目標**: セーブファイルがHDI対応かを判定

#### 3.1 検出関数の実装
```c
static int check_hdi_metadata(const OEMCHAR *filename, NP2METADATA_HDI *metadata)
```

#### 3.2 検出ロジック
1. ファイル末尾から構造体サイズ分を読み取り
2. シグネチャ 'HDIM' の確認
3. バージョン情報の検証
4. チェックサムの確認

**成功条件**: HDI対応ファイルを正確に識別できること

### Stage 4: HDI対応セーブ機能
**目標**: HDI設定を含むセーブ機能を実装

#### 4.1 セーブ関数の実装
- 通常のセーブを実行
- HDI メタデータをファイル末尾に追加

#### 4.2 エラーハンドリング
- セーブ失敗時の適切な処理
- 部分的な失敗への対応
- ファイルの整合性確保

**成功条件**: HDI設定付きでセーブできること

### Stage 5: HDI対応ロード機能
**目標**: HDI設定を復元するロード機能を実装

#### 5.1 ロード関数の実装
- HDI メタデータの読み取り
- 設定の一時保存
- 通常のロード実行
- HDI設定の復元

#### 5.2 設定復元
- HDD/FDD ファイルパスの設定
- IDE タイプの復元
- システム設定の適用

**成功条件**: HDI設定込みでロードできること

### Stage 6: UI統合（基本）
**目標**: 基本的なUI統合を実装

#### 6.1 セーブタイプ選択
- シンプルなダイアログでHDI/通常を選択
- 既存のセーブ機能を拡張

#### 6.2 ロードタイプ選択  
- HDI検出時の選択ダイアログ
- 互換性警告の表示

**成功条件**: ユーザーがセーブ/ロードタイプを選択できること

### Stage 7: UI統合（詳細）
**目標**: 高度なUI機能を実装

#### 7.1 スロット表示の拡張
- HDI対応マーカーの表示
- サムネイル・メタデータ表示

#### 7.2 状態管理ウィンドウの強化
- 詳細情報の表示
- 設定確認機能

**成功条件**: ユーザーフレンドリーなUIが完成すること

## 技術的考慮事項

### コンパイル環境
- Visual Studio 2019
- Windows 10/11 対応
- x64 Release ビルド

### 依存関係
- 既存のstatsave機能
- NP2CFG構造体
- WIN32 API（ファイルI/O）

### エラー処理戦略
- 各段階での適切なエラーコード返却
- ログ出力による問題特定支援
- ユーザーへの分かりやすいエラーメッセージ

### テスト戦略
- 単体テスト：各関数の個別テスト
- 統合テスト：セーブ・ロードの連携テスト
- 互換性テスト：既存ファイルとの互換性確認

## リスクと対策

### 主要リスク
1. **コンパイルエラー**: 段階的実装で最小化
2. **既存機能への影響**: 条件分岐で分離
3. **ファイル互換性**: 慎重な形式設計
4. **設定復元失敗**: エラーハンドリング強化

### 対策
- 各段階でのコミット
- 問題発生時の即時ロールバック
- 十分なテストケース
- ユーザーフィードバック収集

## 品質保証

### コードレビュー
- 各段階での実装レビュー
- セキュリティ観点からの確認
- パフォーマンス影響の評価

### テストケース
- 正常系：基本的なセーブ・ロード
- 異常系：ファイル破損、アクセス権限等
- 境界値：最大パス長、特殊文字等

### ドキュメント
- API仕様の詳細化
- ユーザーマニュアルの作成
- トラブルシューティングガイド

---

作成日: 2025年1月
バージョン: 1.0
更新履歴: 
- 1.0: 初版作成